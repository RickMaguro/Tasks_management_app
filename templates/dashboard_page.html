<html>
<head>
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
    <style>
        /* CSS Grid Layout */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 3fr;
            grid-template-rows: auto auto auto;
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: auto;
        }

        .navbar {
            background-color: #f0f0f0;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .navbar h1 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .urgent-tasks {
            grid-column: 1 / 2;
            grid-row: 1 / 2;
            background-color: #f0f0f0;
            border-radius: 8px;
            text-align: center;
            padding: 15px; /* Smaller padding */
            height: 150px; /* Shorter height */
        }

        .pie-chart {
            grid-column: 1 / 2;
            grid-row: 2 / 3;
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 15px; /* Smaller padding */
            height: 310px; /* Shorter height */
        }

        .line-chart {
            grid-column: 2 / 3;
            grid-row: 1 / 3;
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 20px;
            height: 500px; /* Shorter height */
        }

        .tasks-table {
            grid-column: 1 / 3;
            grid-row: 3 / 4;
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px; /* Limit the height of the table container */
            overflow-y: auto;  /* Enable vertical scrolling */
        }

        .chart-container {
            max-width: 100%;
            height: 100%;
        }

        /* Styling for the table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        /* Navigation Buttons Styling */
        .navigation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .navigation-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .navigation-buttons form {
            margin: 0 10px;
        }

        .navigation-buttons button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .navigation-buttons button:hover {
            background-color: #0056b3;
        }

        .logout-button {
            text-align: center;
        }

        .logout-button button {
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .logout-button button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h2>Data of tasks due in the next 30 days<h2>
    </div>
    <div class="dashboard-container">
        <!-- Urgent Tasks Number Metric -->
        <div class="urgent-tasks">
            <h2>Urgent Tasks</h2>
            <p style="font-size: 48px; color: red;">{{ urgent_tasks }}</p>
        </div>

        <!-- Pie Chart: Tasks by Priority -->
        <div class="pie-chart">
            <h2>Pie by Priorities</h2>
            <canvas id="tasksPriorityPieChart" class="chart-container"></canvas>
        </div>

        <!-- Line Chart: Tasks Due in the Next 30 Days -->
        <div class="line-chart">
            <h2>Line chart by Due dates</h2>
            <canvas id="tasksDueLineChart" class="chart-container"></canvas>
        </div>

        <!-- Table View: All Tasks -->
        <div class="tasks-table">
            <h2>Table of task details</h2>
            <table>
                <thead>
                    <tr>
                        <th>User Email</th>
                        <th>Task</th>
                        <th>Due Date</th>
                        <th>Priority</th>
                        <th>Urgent</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task.user_email }}</td>
                        <td>{{ task.task }}</td>
                        <td>{{ task.due_by }}</td>
                        <td>{{ task.get_priority_display }}</td>
                        <td>{{ task.is_urgent|yesno:"Yes,No" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Navigation buttons -->
    <div class="navigation-container">
        <div class="navigation-buttons">
            <form action="{% url 'landing_page' %}">
                <button type="submit">Back to Home</button>
            </form>

            <form action="{% url 'task_page' %}">
                <button type="submit">Go to Task Page</button>
            </form>
        </div>

        <!-- Logout button -->
        <div class="logout-button">
            <form action="{% url 'logout' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit">Logout</button>
            </form>
        </div>
    </div>

    <!-- Chart.js Scripts -->
    <script>
        // Line Chart: Tasks Due in the Next 30 Days
        var ctxLine = document.getElementById('tasksDueLineChart').getContext('2d');
        var tasksDueLineChart = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: [{% for item in tasks_due_dates %}"{{ item.date|date:'Y-m-d' }}"{% if not forloop.last %},{% endif %}{% endfor %}],
                datasets: [{
                    label: 'Tasks Due',
                    data: [{% for item in tasks_due_dates %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    fill: false,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Pie Chart: Tasks by Priority
        var ctxPie = document.getElementById('tasksPriorityPieChart').getContext('2d');
        var tasksPriorityPieChart = new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: [{% for item in task_count_by_priority %}"Priority {{ item.priority }}"{% if not forloop.last %},{% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for item in task_count_by_priority %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(54, 162, 235, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                },
                // Reduce the size of the pie
                layout: {
                    padding: {
                        top: 20,
                        bottom: 20,
                        left: 20,
                        right: 20
                    }
                },
                // Reduce the cutout percentage to make the pie smaller
                cutout: '50%',
            }
        });
    </script>
</body>
</html>